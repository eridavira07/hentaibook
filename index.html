<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinding Status (Publik)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <header>
        <h1>Dinding Status Anonim</h1>
    </header>

    <main>
        <section id="posts-container"></section>
    </main>
    
    <div id="comments-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('comments-modal')">&times;</span>
            <h3>Komentar Palsu</h3>
            <div id="modal-comments-list" class="comments-container">
                </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyC6eQQ5KmfNeE-MbbGztfgxUr-Q388QKg4",
          authDomain: "anon-chat-eri.firebaseapp.com",
          databaseURL: "https://anon-chat-eri-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "anon-chat-eri",
          storageBucket: "anon-chat-eri.appspot.com",
          messagingSenderId: "770226352457",
          appId: "1:770226352457:web:43d01526df75e5e49cea98",
          measurementId: "G-2YRM1KMDDM"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const postsRef = database.ref('statuses').orderByChild('timestamp');

        const POSTS_PER_LOAD = 5;
        let LAST_KEY_LOADED = null;
        let LAST_TIMESTAMP_LOADED = null;
        let IS_INITIAL_LOAD = true;

        const container = document.getElementById('posts-container');
        
        
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-btn';
        loadMoreBtn.textContent = 'Muat Lebih Banyak Status';
        loadMoreBtn.onclick = loadPosts;
        container.after(loadMoreBtn);
        
        loadPosts();

        async function loadPosts() {
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Memuat...';

            let finalQuery = postsRef;

            if (IS_INITIAL_LOAD) {
                finalQuery = finalQuery.limitToLast(POSTS_PER_LOAD);
            } else if (LAST_KEY_LOADED) {
                try {
                    const snapshot = await database.ref('statuses').child(LAST_KEY_LOADED).once('value');
                    LAST_TIMESTAMP_LOADED = snapshot.val() ? snapshot.val().timestamp : null;
                } catch (e) {
                    loadMoreBtn.textContent = 'Gagal memuat data.';
                    return;
                }

                if (!LAST_TIMESTAMP_LOADED) {
                    loadMoreBtn.textContent = 'Tidak ada lagi status yang tersedia.';
                    return;
                }
                
                finalQuery = postsRef
                            .endBefore(LAST_TIMESTAMP_LOADED, LAST_KEY_LOADED)
                            .limitToLast(POSTS_PER_LOAD);

            } else {
                loadMoreBtn.textContent = 'Tidak ada lagi status yang tersedia.';
                return;
            }

            finalQuery.once('value', snapshot => {
                const postsArray = [];
                
                snapshot.forEach(childSnapshot => {
                    postsArray.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });

                const numResults = postsArray.length;
                
                if (numResults > 0) {
                    const oldestPost = postsArray[0];
                    LAST_KEY_LOADED = oldestPost.id; 

                    postsArray.reverse(); 

                    postsArray.forEach(post => {
                        displayPost(post.id, post);
                    });
                    
                    IS_INITIAL_LOAD = false; 
                }
                
                if (numResults < POSTS_PER_LOAD) {
                    loadMoreBtn.textContent = 'Tidak ada lagi status yang tersedia.';
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.style.opacity = 0.5;
                } else {
                    loadMoreBtn.textContent = 'Muat Lebih Banyak Status';
                    loadMoreBtn.disabled = false;
                }
                
                if (IS_INITIAL_LOAD && numResults === 0) {
                     container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Belum ada status yang diposting.</p>';
                     loadMoreBtn.style.display = 'none';
                }
            });
        }
        
        function displayPost(id, post) {
            const comments = post.comments || {};
            const commentCount = Object.keys(comments).length;
            
            const postElement = document.createElement('div');
            postElement.classList.add('post-card');
            postElement.id = `post-${id}`;
            
            postElement.innerHTML = `
                <p class="post-text">${post.text}</p>
                <div class="image-wrapper">
                    <img 
                        src="${post.thumbnail}" 
                        class="post-image-thumbnail" 
                        onclick="loadOriginalImage('${id}', '${post.original}')"
                        alt="Thumbnail"
                    >
                    <img 
                        src="" 
                        class="post-image-original hidden" 
                        alt="Gambar Original"
                    >
                </div>
                
                <div class="post-actions">
                    <div class="action-item">
                        ‚ù§Ô∏è <span class="likes-count">${post.likes || 0}</span> Like
                    </div>
                    <div class="action-item" onclick="openCommentsModal('${id}')" style="cursor: pointer;">
                        üí¨ <span class="comments-count">${commentCount}</span> Komentar
                    </div>
                    <div class="action-item">
                        üì§ <span class="shares-count">${post.shares || 0}</span> Bagikan
                    </div>
                </div>

                <div class="post-footer">
                    <small>${new Date(post.timestamp).toLocaleString()}</small>
                </div>
            `;

            container.appendChild(postElement); 
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        window.openCommentsModal = function(postId) {
            const modal = document.getElementById('comments-modal');
            const commentsList = document.getElementById('modal-comments-list');
            commentsList.innerHTML = '<p style="text-align: center;">Memuat komentar...</p>';

            postsRef.child(postId).child('comments').orderByChild('timestamp').once('value', snapshot => {
                commentsList.innerHTML = '';
                const commentsArray = [];
                
                snapshot.forEach(childSnapshot => {
                    commentsArray.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                if (commentsArray.length === 0) {
                    commentsList.innerHTML = '<p style="text-align: center;">Belum ada komentar.</p>';
                    modal.classList.remove('hidden');
                    return;
                }

                // Tampilkan komentar terbaru di atas
                commentsArray.reverse().forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment-item');
                    commentElement.innerHTML = `
                        <strong>${comment.name}</strong>
                        <p>${comment.text}</p>
                    `;
                    commentsList.appendChild(commentElement);
                });

                modal.classList.remove('hidden');
            });
        }
        
        window.loadOriginalImage = function(postId, originalLink) {
            const postElement = document.getElementById(`post-${postId}`);
            const thumbnailImg = postElement.querySelector('.post-image-thumbnail');
            const originalImg = postElement.querySelector('.post-image-original');

            if (originalImg.src === originalLink && !originalImg.classList.contains('hidden')) {
                return; 
            }

            originalImg.src = originalLink;

            originalImg.onload = function() {
                thumbnailImg.classList.add('hidden'); 
                originalImg.classList.remove('hidden'); 
                thumbnailImg.onclick = null;
            };
            originalImg.onerror = function() {
            };
        };
    </script>
</body>
</html>